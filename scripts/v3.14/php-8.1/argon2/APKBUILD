# This package is being back-ported to support PHp 8.0 Argon2 password_hash() algo.
# Original file: https://github.com/alpinelinux/aports/blob/master/testing/argon2/APKBUILD

# Any license indication here contained takes lesser precedence than the original
# licenses on the official sources. It's just a backport.

# Contributor: Corey Oliver <coreyjonoliver@gmail.com>
# Maintainer: Corey Oliver <coreyjonoliver@gmail.com>
pkgname=argon2
srcdir="/tmp/src-$pkgname"
pkgbasedir="/tmp/pkg-$pkgname"
_pkgname=phc-winner-argon2
pkgver=20190702
provides="php-argon2=8.1"
_soname=0.0.0
pkgrel=1
pkgdesc="The password hash Argon2, winner of PHC"
url="https://github.com/P-H-C/phc-winner-argon2"
arch="all !armhf"
license="Apache-2.0 CC0-1.0"
subpackages="$pkgname-dev libargon2"
source="$pkgname-$pkgver.tar.gz::https://github.com/P-H-C/$_pkgname/archive/$pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$pkgver"

build() {
    cd "$builddir"
    make && make test
}

package() {
    cd "$builddir"
    make DESTDIR="$pkgdir" install || return 1

    # A version number is not appended to the shared library file by default, so we do it ourselves
    mv "$pkgdir"/usr/lib/x86_64-linux-gnu/libargon2.so "$pkgdir"/usr/lib/x86_64-linux-gnu/libargon2.so.$_soname || return 1
    ln -s libargon2.so.$_soname "$pkgdir"/usr/lib/x86_64-linux-gnu/libargon2.so || return 1
	ln -s libargon2.so.$_soname "$pkgdir"/usr/lib/x86_64-linux-gnu/libargon2.so.${_soname%%.*} || return 1
}

libargon2() {
    pkgdesc="The password hash Argon2 library, winner of PHC"
    mkdir -p "$subpkgdir"/usr
    mv "$pkgdir"/usr/lib/x86_64-linux-gnu "$subpkgdir"/usr
}
sha512sums="
0a4cb89e8e63399f7df069e2862ccd05308b7652bf4ab74372842f66bcc60776399e0eaf979a7b7e31436b5e6913fe5b0a6949549d8c82ebd06e0629b106e85f  argon2-20190702.tar.gz
"
